(self.webpackChunkyuewu_dev=self.webpackChunkyuewu_dev||[]).push([[8155],{97259:(E,W,a)=>{"use strict";a.r(W),a.d(W,{default:()=>Ve});var t=a(53547),u=a(69554),g=a(22072),S=a(86706),h=a(88767),w=a(22551),oe=a(17034),re=a(185),ne=a(53979),se=a(29728),le=a(49066),ie=a(77197),ce=a(85018),de=a(45697),m=a.n(de),$=a(54863),D=a(41580),y=a(11047),c=a(53616);function ue({status:e,data:o}){return{type:c.QM,payload:{status:e,workflows:o}}}function ge(e){return{type:c.x4,payload:{stageId:e}}}function me(e={}){return{type:c.Ot,payload:e}}function H(e,o){return{type:c.Nj,payload:{stageId:e,...o}}}function fe(e,o){return{type:c.$k,payload:{newIndex:o,oldIndex:e}}}var F=a(75515),pe=a(99782);const B=(0,$.default)(pe.Z)`
  > circle {
    fill: ${({theme:e})=>e.colors.neutral150};
  }
  > path {
    fill: ${({theme:e})=>e.colors.neutral600};
  }
`,ve=(0,$.default)(D.x)`
  border-radius: 26px;

  svg {
    height: ${({theme:e})=>e.spaces[6]};
    width: ${({theme:e})=>e.spaces[6]};

    > path {
      fill: ${({theme:e})=>e.colors.neutral600};
    }
  }

  &:hover {
    color: ${({theme:e})=>e.colors.primary600} !important;
    ${F.Z} {
      color: ${({theme:e})=>e.colors.primary600} !important;
    }

    ${B} {
      > circle {
        fill: ${({theme:e})=>e.colors.primary600};
      }
      > path {
        fill: ${({theme:e})=>e.colors.neutral100};
      }
    }
  }

  &:active {
    ${F.Z} {
      color: ${({theme:e})=>e.colors.primary600};
    }

    ${B} {
      > circle {
        fill: ${({theme:e})=>e.colors.primary600};
      }
      > path {
        fill: ${({theme:e})=>e.colors.neutral100};
      }
    }
  }
`;function K({children:e,...o}){return t.createElement(ve,{as:"button",background:"neutral0",border:"neutral150",paddingBottom:3,paddingLeft:4,paddingRight:4,paddingTop:3,shadow:"filterShadow",...o},t.createElement(y.k,{gap:2},t.createElement(B,{"aria-hidden":!0}),t.createElement(F.Z,{variant:"pi",fontWeight:"bold",textColor:"neutral500"},e)))}K.propTypes={children:m().node.isRequired};var he=a(63237),we=a(48734),Se=a(74756),X=a(12028),ye=a(63081),ke=a(11276),Q=a(67819),Ee=a(16364),Y=a(70642),Ce=a(20022),be=a(12814),We=a(61080),j=a(13037),De=a(75642),Re=a(13920);const xe=(0,j.s)();function Ie(){return t.createElement(D.x,{background:"primary100",borderStyle:"dashed",borderColor:"primary600",borderWidth:"1px",display:"block",hasRadius:!0,padding:6,shadow:"tableShadow"})}function J({id:e,index:o,canDelete:r,canReorder:f,isOpen:i=!1,stagesCount:l}){const n=s=>`${s+1} of ${l}`,d=s=>{x(p({id:"dnd.grab-item",defaultMessage:"{item}, grabbed. Current position in list: {position}. Press up and down arrow to change position, Spacebar to drop, Escape to cancel."},{item:v.value,position:n(s)}))},b=s=>{x(p({id:"dnd.drop-item",defaultMessage:"{item}, dropped. Final position in list: {position}."},{item:v.value,position:n(s)}))},z=()=>{x(p({id:"dnd.cancel-item",defaultMessage:"{item}, dropped. Re-order cancelled."},{item:v.value}))},R=(s,O)=>{x(p({id:"dnd.reorder",defaultMessage:"{item}, moved. New position in list: {position}."},{item:v.value,position:n(s)})),I(fe(O,s))},[Z,x]=t.useState(null),{formatMessage:p}=(0,g.Z)(),{trackUsage:L}=(0,w.useTracking)(),I=(0,S.useDispatch)(),[M,U]=t.useState(i),[v,V]=(0,u.useField)(`stages.${o}.name`),[C,P]=(0,u.useField)(`stages.${o}.color`),[{handlerId:k,isDragging:N,handleKeyDown:T},He,Ke,Xe,te]=(0,De.Y9)(f,{index:o,item:{name:v.value},onGrabItem:d,onDropItem:b,onMoveItem:R,onCancel:z,type:c.uL.STAGE}),Qe=(0,Re.FE)(He,Ke),Ye=xe.map(({hex:s,name:O})=>({value:s,label:p({id:"Settings.review-workflows.stage.color.name",defaultMessage:"{name}"},{name:O}),color:s}));t.useEffect(()=>{te((0,We.rX)(),{captureDraggingState:!1})},[te,o]);const{themeColorName:Je}=C.value?(0,j.k)(C.value):{};return t.createElement(D.x,{ref:Qe},Z&&t.createElement(he.T,{"aria-live":"assertive"},Z),N?t.createElement(Ie,null):t.createElement(we.U,{size:"S",variant:"primary",onToggle:()=>{U(!M),M||L("willEditStage")},expanded:M,shadow:"tableShadow"},t.createElement(Se.B,{title:v.value,togglePosition:"left",action:t.createElement(y.k,null,r&&t.createElement(X.h,{background:"transparent",icon:t.createElement(Ce.Z,null),label:p({id:"Settings.review-workflows.stage.delete",defaultMessage:"Delete stage"}),noBorder:!0,onClick:()=>I(ge(e))}),t.createElement(X.h,{background:"transparent",forwardedAs:"div",role:"button",noBorder:!0,tabIndex:0,"data-handler-id":k,ref:Xe,label:p({id:"Settings.review-workflows.stage.drag",defaultMessage:"Drag"}),onClick:s=>s.stopPropagation(),onKeyDown:T},t.createElement(be.Z,null)))}),t.createElement(ye.v,{padding:6,background:"neutral0",hasRadius:!0},t.createElement(ke.r,{gap:4},t.createElement(Q.P,{col:6},t.createElement(Ee.o,{...v,id:v.name,label:p({id:"Settings.review-workflows.stage.name.label",defaultMessage:"Stage name"}),error:V.error??!1,onChange:s=>{v.onChange(s),I(H(e,{name:s.target.value}))},required:!0})),t.createElement(Q.P,{col:6},t.createElement(Y.q4,{error:P?.error??!1,id:C.name,required:!0,label:p({id:"content-manager.reviewWorkflows.stage.color",defaultMessage:"Color"}),onChange:s=>{C.onChange({target:{value:s}}),I(H(e,{color:s}))},value:C.value.toUpperCase(),startIcon:t.createElement(y.k,{as:"span",height:2,background:C.value,borderColor:Je==="neutral0"?"neutral150":"transparent",hasRadius:!0,shrink:0,width:2})},Ye.map(({value:s,label:O,color:ae})=>{const{themeColorName:qe}=(0,j.k)(ae);return t.createElement(Y.ag,{value:s,key:s,startIcon:t.createElement(y.k,{as:"span",height:2,background:ae,borderColor:qe==="neutral0"?"neutral150":"transparent",hasRadius:!0,shrink:0,width:2})},O)})))))))}J.propTypes=m().shape({id:m().number.isRequired,color:m().string.isRequired,canDelete:m().bool.isRequired,canReorder:m().bool.isRequired,stagesCount:m().number.isRequired}).isRequired;const Me=(0,$.default)(D.x)`
  position: relative;
`,Te=(0,$.default)(D.x)`
  left: 50%;
  position: absolute;
  top: 0;
  transform: translateX(-50%);
`;function G({stages:e}){const{formatMessage:o}=(0,g.Z)(),r=(0,S.useDispatch)(),{trackUsage:f}=(0,w.useTracking)();return t.createElement(y.k,{direction:"column",gap:6,width:"100%"},t.createElement(Me,{spacing:4,width:"100%"},t.createElement(Te,{background:"neutral200",height:"100%",width:2,zIndex:1}),t.createElement(y.k,{direction:"column",alignItems:"stretch",gap:6,zIndex:2,position:"relative",as:"ol"},e.map((i,l)=>{const n=i?.id??i.__temp_key__;return t.createElement(D.x,{key:`stage-${n}`,as:"li"},t.createElement(J,{id:n,index:l,canDelete:e.length>1,isOpen:!i.id,canReorder:e.length>1,stagesCount:e.length}))}))),t.createElement(y.k,{direction:"column",gap:6},t.createElement(K,{type:"button",onClick:()=>{r(me({name:""})),f("willCreateStage")}},o({id:"Settings.review-workflows.stage.add",defaultMessage:"Add new stage"}))))}G.defaultProps={stages:[]},G.propTypes={stages:m().arrayOf(m().shape({id:m().number,__temp_key__:m().number,name:m().string.isRequired}))};var q=a(18172),$e=a(18446),Ae=a.n($e);const _={status:"loading",serverState:{currentWorkflow:null,workflows:[]},clientState:{currentWorkflow:{data:null,isDirty:!1,hasDeletedServerStages:!1}}};function Le(e=_,o){return(0,q.produce)(e,r=>{const{payload:f}=o;switch(o.type){case c.QM:{const{status:i,workflows:l}=f;if(r.status=i,l?.length>0){let n=l[0];n={...n,stages:n.stages.map(d=>({...d,color:d?.color??c.FT}))},r.serverState.workflows=l,r.serverState.currentWorkflow=n,r.clientState.currentWorkflow.data=n,r.clientState.currentWorkflow.hasDeletedServerStages=!1}break}case c.x4:{const{stageId:i}=f,{currentWorkflow:l}=e.clientState;r.clientState.currentWorkflow.data.stages=l.data.stages.filter(n=>(n?.id??n.__temp_key__)!==i),l.hasDeletedServerStages||(r.clientState.currentWorkflow.hasDeletedServerStages=!!e.serverState.currentWorkflow.stages.find(n=>n.id===i));break}case c.Ot:{const{currentWorkflow:i}=e.clientState;i.data||(r.clientState.currentWorkflow.data={stages:[]});const l=Pe(r.clientState.currentWorkflow.data.stages);r.clientState.currentWorkflow.data.stages.push({...f,color:f?.color??c.FT,__temp_key__:l});break}case c.Nj:{const{currentWorkflow:i}=e.clientState,{stageId:l,...n}=f;r.clientState.currentWorkflow.data.stages=i.data.stages.map(d=>(d.id??d.__temp_key__)===l?{...d,...n}:d);break}case c.$k:{const{currentWorkflow:{data:{stages:i}}}=e.clientState,{newIndex:l,oldIndex:n}=f;if(l>=0&&l<i.length){const d=i[n];let b=[...i];b.splice(n,1),b.splice(l,0,d),r.clientState.currentWorkflow.data.stages=b}break}default:break}e.clientState.currentWorkflow.data&&(r.clientState.currentWorkflow.isDirty=!Ae()((0,q.current)(r.clientState.currentWorkflow).data,r.serverState.currentWorkflow))})}const Pe=(e=[])=>{const o=e.map(r=>r.id??r.__temp_key__);return Math.max(...o,-1)+1};function Ne(e,o){const r=(0,S.useStore)();(0,t.useEffect)(()=>{r.injectReducer(e,o)},[r,e,o])}var Oe=a(53752),A=a(87561);function Fe({formatMessage:e}){return A.Ry({stages:A.IX().of(A.Ry().shape({name:A.Z_().required(e({id:"Settings.review-workflows.validation.stage.name",defaultMessage:"Name is required"})).max(255,e({id:"Settings.review-workflows.validation.stage.max-length",defaultMessage:"Name can not be longer than 255 characters"})),color:A.Z_().required(e({id:"Settings.review-workflows.validation.stage.color",defaultMessage:"Color is required"})).matches(/^#(?:[0-9a-fA-F]{3}){1,2}$/i)}))})}var Ze=a(87751),Be=a(12645);const je=(0,$.default)(y.k)`
  svg path {
    fill: ${({theme:e})=>e.colors.neutral600};
  }
`;function ee({name:e}){return t.createElement(y.k,{background:"primary100",borderStyle:"dashed",borderColor:"primary600",borderWidth:"1px",gap:3,hasRadius:!0,padding:3,shadow:"tableShadow",width:(0,w.pxToRem)(300)},t.createElement(je,{alignItems:"center",background:"neutral200",borderRadius:"50%",height:6,justifyContent:"center",width:6},t.createElement(Be.Z,{width:`${8/16}rem`})),t.createElement(F.Z,{fontWeight:"bold"},e))}ee.propTypes={name:m().string.isRequired};var Ge=a(27887);function ze({type:e,item:o}){switch(e){case c.uL.STAGE:return t.createElement(ee,{...o});default:return null}}function Ue(){const{trackUsage:e}=(0,w.useTracking)(),{formatMessage:o}=(0,g.Z)(),r=(0,S.useDispatch)(),{put:f}=(0,w.useFetchClient)(),{formatAPIError:i}=(0,w.useAPIErrorHandler)(),l=(0,w.useNotification)(),{workflows:n,status:d,refetch:b}=(0,Oe.n)(),{status:z,clientState:{currentWorkflow:{data:R,isDirty:Z,hasDeletedServerStages:x}}}=(0,S.useSelector)(k=>k?.[c.sN]??_),[p,L]=(0,t.useState)(!1),{mutateAsync:I,isLoading:M}=(0,h.useMutation)(async({workflowId:k,stages:N})=>{const{data:{data:T}}=await f(`/admin/review-workflows/workflows/${k}/stages`,{data:N});return T},{onSuccess(){l({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}}),U=async(k,N)=>{try{return await I({workflowId:k,stages:N})}catch(T){return l({type:"warning",message:i(T)}),null}},v=async()=>{await U(R.id,R.stages),await b(),L(!1)},V=async()=>{await v()},C=()=>{L(k=>!k)},P=(0,u.useFormik)({enableReinitialize:!0,initialValues:R,async onSubmit(){x?L(!0):v()},validationSchema:Fe({formatMessage:o}),validateOnChange:!1});return Ne(c.sN,Le),(0,t.useEffect)(()=>{r(ue({status:d,data:n}))},[d,n,r]),(0,t.useEffect)(()=>{e("didViewWorkflow")},[]),t.createElement(w.CheckPagePermissions,{permissions:Ze.Z.settings["review-workflows"].main},t.createElement(oe.A,null,t.createElement(w.SettingsPageTitle,{name:o({id:"Settings.review-workflows.page.title",defaultMessage:"Review Workflows"})}),t.createElement(re.o,{tabIndex:-1},t.createElement(Ge.r,{renderItem:ze}),t.createElement(u.FormikProvider,{value:P},t.createElement(u.Form,{onSubmit:P.handleSubmit},t.createElement(ne.T,{primaryAction:t.createElement(se.z,{startIcon:t.createElement(ce.Z,null),type:"submit",size:"M",disabled:!Z,loading:!p&&M},o({id:"global.save",defaultMessage:"Save"})),title:o({id:"Settings.review-workflows.page.title",defaultMessage:"Review Workflows"}),subtitle:o({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:R?.stages?.length??0})}),t.createElement(le.D,null,z==="loading"&&t.createElement(ie.a,null,o({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})),t.createElement(G,{stages:P.values?.stages})))),t.createElement(w.ConfirmDialog,{bodyText:{id:"Settings.review-workflows.page.delete.confirm.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage. Are you sure you want to save?"},isConfirmButtonLoading:M,isOpen:p,onToggleDialog:C,onConfirm:V}))))}const Ve=Ue},51584:(E,W,a)=>{var t=a(44239),u=a(37005),g="[object Boolean]";function S(h){return h===!0||h===!1||u(h)&&t(h)==g}E.exports=S},7654:(E,W,a)=>{var t=a(81763);function u(g){return t(g)&&g!=+g}E.exports=u},81763:(E,W,a)=>{var t=a(44239),u=a(37005),g="[object Number]";function S(h){return typeof h=="number"||u(h)&&t(h)==g}E.exports=S},7334:(E,W,a)=>{var t=a(79833);function u(g){return t(g).toLowerCase()}E.exports=u}}]);
